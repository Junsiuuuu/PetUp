<!DOCTYPE html>
<html>

<head>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            /* 아래쪽 정렬 */
            height: 100vh;
            overflow: hidden;
            /* 스크롤바 방지 */
            font-family: 'Malgun Gothic', sans-serif;
        }

        .bubble {
            position: relative;
            background: #ffffff;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 10px 15px;

            /* ▼▼▼ [수정됨] 크기 자동 조절 CSS ▼▼▼ */
            width: auto;
            /* 내용에 맞게 늘어남 */
            min-width: 150px;
            /* 최소 크기 (너무 작아짐 방지) */
            max-width: 300px;
            /* 최대 크기 (너무 길어짐 방지) */
            word-break: keep-all;
            /* 단어 중간에 끊기지 않게 */
            /* ▲▲▲ -------------------------- ▲▲▲ */

            margin-bottom: 15px;

            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            animation: pop 0.3s ease-out;
        }

        .bubble::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 12px 10px 0;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .bubble::before {
            content: '';
            position: absolute;
            bottom: -9px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 12px 10px 0;
            border-style: solid;
            border-color: #fff transparent transparent transparent;
            /* Original white color retained */
            z-index: 1;
        }

        /* ▲▲▲ [New] 꼬리 위쪽 방향 (Mac Tray용) 시작 ▲▲▲ */
        .bubble.tail-top::after {
            bottom: auto;
            top: -12px;
            /* 위쪽으로 튀어나오게 */
            border-width: 0 10px 12px;
            /* 위쪽 뾰족 */
            border-color: transparent transparent #333 transparent;
        }

        .bubble.tail-top::before {
            bottom: auto;
            top: -9px;
            border-width: 0 10px 12px;
            border-color: transparent transparent #fff transparent;
        }

        /* ▼▼▼ [New] 꼬리 위쪽 방향 끝 ▼▼▼ */

        h3 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: #ff6b6b;
        }

        p {
            margin: 0;
            font-size: 12px;
            color: #333;
            line-height: 1.4;
        }

        @keyframes pop {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="bubble" id="bubble-container">
        <h3 id="title">상태 메시지</h3>
        <p id="message">내용이 들어갑니다.</p>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        ipcRenderer.on('update-message', (event, data) => {
            const titleEl = document.getElementById('title');
            const msgEl = document.getElementById('message');
            const container = document.getElementById('bubble-container');

            titleEl.innerText = data.title;
            msgEl.innerText = data.content;

            // [NEW] 효과음 재생 (중복 방지)
            if (data.isNewPopup && data.soundVolume > 0 && data.soundPath) {
                try {
                    // 기존 오디오가 있으면 정지
                    if (window.currentAudio) {
                        window.currentAudio.pause();
                        window.currentAudio.currentTime = 0;
                    }

                    const audio = new Audio(data.soundPath);
                    audio.volume = data.soundVolume / 100;
                    audio.play().catch(e => console.log('Audio play failed:', e));

                    window.currentAudio = audio; // 현재 오디오 저장
                } catch (e) {
                    console.log('Audio init failed:', e);
                }
            }

            // 꼬리 방향 설정
            if (data.tailPosition === 'top') {
                container.classList.add('tail-top');
                // 위쪽 꼬리일 때는 align-items를 flex-start로 바꿔야 짤리지 않을 수도 있음. 
                // 하지만 body가 flex-end라... body 설정을 건드리긴 복잡하니 bubble margin-top을 줌
                container.style.marginTop = '15px';
                container.style.marginBottom = '0';
            } else {
                container.classList.remove('tail-top');
                container.style.marginTop = '0';
                container.style.marginBottom = '15px';
            }

            requestAnimationFrame(() => {
                const width = container.offsetWidth + 30;
                const height = container.offsetHeight + 30;
                ipcRenderer.send('resize-bubble', { width, height });
            });
        });

        ipcRenderer.on('update-tail', (event, tailPosition) => {
            const container = document.getElementById('bubble-container');
            if (tailPosition === 'top') {
                container.classList.add('tail-top');
                container.style.marginTop = '15px';
                container.style.marginBottom = '0';
            } else {
                container.classList.remove('tail-top');
                container.style.marginTop = '0';
                container.style.marginBottom = '15px';
            }
            // 스타일 변경 후 크기 재조정 필요 가능성 있음
            requestAnimationFrame(() => {
                const width = container.offsetWidth + 30;
                const height = container.offsetHeight + 30;
                ipcRenderer.send('resize-bubble', { width, height });
            });
        });

        document.body.addEventListener('click', () => {
            ipcRenderer.send('hide-bubble');
        });
    </script>
</body>

</html>